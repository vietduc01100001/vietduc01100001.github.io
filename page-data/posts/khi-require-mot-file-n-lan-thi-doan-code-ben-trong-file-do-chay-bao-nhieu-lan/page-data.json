{"componentChunkName":"component---src-templates-post-template-tsx","path":"/posts/khi-require-mot-file-n-lan-thi-doan-code-ben-trong-file-do-chay-bao-nhieu-lan/","result":{"data":{"markdownRemark":{"id":"2f21cec3-a191-5176-a960-f4092ee9f1e7","html":"<p>H√¥m nay cu·ªëi sprint, ƒëang ho√†n th√†nh n·ªët c√°i coverage test cho ƒë√∫ng h·∫°n th√¨ m√¨nh g·∫∑p ph·∫£i t√¨nh hu·ªëng nh∆∞ th·∫ø n√†y.</p>\n<h2 id=\"the-problem\" style=\"position:relative;\"><a href=\"#the-problem\" aria-label=\"the problem permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The problem</h2>\n<p>M√¨nh c√≥ file <code class=\"language-text\">axon.js</code> export m·ªôt h√†m <code class=\"language-text\">connect()</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> axon <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axon'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> sock <span class=\"token operator\">=</span> axon<span class=\"token punctuation\">.</span><span class=\"token function\">socket</span><span class=\"token punctuation\">(</span><span class=\"token string\">'push'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">connect</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">addr</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Promise</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">resolve</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    sock<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>addr<span class=\"token punctuation\">,</span> <span class=\"token parameter\">err</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>H√†m n√†y ƒë∆∞·ª£c d√πng ·ªü file <code class=\"language-text\">index.js</code>:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> axon <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./axon'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nmodule<span class=\"token punctuation\">.</span>exports<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">doSomething</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> connected <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> axon<span class=\"token punctuation\">.</span><span class=\"token function\">connect</span><span class=\"token punctuation\">(</span><span class=\"token string\">'real_address'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>connected<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">// do something else</span>\n    <span class=\"token comment\">// ...</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ƒê·ªÉ test case khi ch·∫°y kh√¥ng ph·∫£i connect ra ngo√†i th√¨ m√¨nh s·∫Ω mock. √ù t∆∞·ªüng l√∫c ƒë·∫ßu l√† mock th·∫±ng <code class=\"language-text\">axon.socket()</code>. ƒêo·∫°n test case l√∫c ƒë√≥ c·ªßa m√¨nh nh√¨n nh∆∞ sau:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'doSomething() succeeds'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">done</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    axon<span class=\"token punctuation\">.</span>socket <span class=\"token operator\">=</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mockImplementationOnce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function-variable function\">connect</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">addr<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> index <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> success <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> index<span class=\"token punctuation\">.</span><span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>success<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Ch·∫°y <code class=\"language-text\">jest --coverage</code> l√™n th·∫•y test case pass xanh l√®, cover lu√¥n ƒë∆∞·ª£c d√≤ng <code class=\"language-text\">resolve(true);</code> trong <code class=\"language-text\">axon.js</code> ngon l√†nh. ƒêang th·∫Øng, m√¨nh copy paste l√†m c√°i test case th·ª© hai cho tr∆∞·ªùng h·ª£p connect fail.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'doSomething() fails'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">done</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    axon<span class=\"token punctuation\">.</span>socket <span class=\"token operator\">=</span> jest<span class=\"token punctuation\">.</span><span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">mockImplementationOnce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function-variable function\">connect</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">addr<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> index <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> success <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> index<span class=\"token punctuation\">.</span><span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>success<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>∆†, <strong>‚Äú1 failed‚Äù</strong>, Jest said. Sai l√†m sao ƒë∆∞·ª£c nh·ªâ? M√¨nh ƒë√£ <code class=\"language-text\">mockReset()</code> trong <code class=\"language-text\">beforeEach()</code> r·ªìi, l·∫°i c√≤n d√πng <code class=\"language-text\">mockImplementationOnce()</code> n·ªØa. Th·ª≠ debug th√¨ th·∫•y <code class=\"language-text\">connected</code> l√† <code class=\"language-text\">false</code> r√µ r√†ng, test case pass b√¨nh th∆∞·ªùng. Nh∆∞ng c·ª© ch·∫°y <code class=\"language-text\">jest --coverage</code> th√¨ kh√¥ng pass. Th·ª≠ x√≥a <code class=\"language-text\">node_modules</code> r·ªìi <code class=\"language-text\">npm install</code> l·∫°i v·∫´n v·∫≠y. K√¨ l·∫°!</p>\n<p>Sau m·ªôt h·ªìi loay hoay c·∫ßu c·ª©u b√°c Gu g·ªì, cu·ªëi c√πng b√°c ph√°n cho m·ªôt c√¢u nh∆∞ n√†y: <strong><em>‚ÄúModules are cached after the first time they are loaded.‚Äù</em></strong></p>\n<h2 id=\"introduction-to-how-require-in-nodejs-works\" style=\"position:relative;\"><a href=\"#introduction-to-how-require-in-nodejs-works\" aria-label=\"introduction to how require in nodejs works permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Introduction to how <code class=\"language-text\">require</code> in Node.js works</h2>\n<p><code class=\"language-text\">require</code> l√† m·ªôt built-in function c·ªßa Node.js, nh·∫≠n v√†o m·ªôt bi·∫øn string l√† path d·∫´n ƒë·∫øn file c·∫ßn require v√† tr·∫£ v·ªÅ m·ªôt object, m·ªôt h√†m ho·∫∑c b·∫•t k√¨ c√°i g√¨ kh√°c m√† file ƒë√≥ export ra. V√¨ c√∫ ph√°p s·ª≠ d·ª•ng ƒë∆°n gi·∫£n, l·∫°i xu·∫•t hi·ªán ·ªü m·ªçi n∆°i trong project n√™n ƒë√¥i khi ch√∫ng ta kh√¥ng quan t√¢m <code class=\"language-text\">require</code> ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o.</p>\n<p>Khi ƒë∆∞·ª£c g·ªçi, <code class=\"language-text\">require</code> s·∫Ω th·ª±c thi l·∫ßn l∆∞·ª£t theo c√°c b∆∞·ªõc sau:</p>\n<ol>\n<li>T√¨m absolute path c·ªßa file ƒëang ƒë∆∞·ª£c require, n·∫øu kh√¥ng truy·ªÅn file extension th√¨ m·∫∑c ƒë·ªãnh t√¨m v·ªõi extension <code class=\"language-text\">.js</code></li>\n<li>X√°c ƒë·ªãnh content type c·ªßa file ƒë√≥, ngo√†i <code class=\"language-text\">.js</code> th√¨ Node.js c√≥ th·ªÉ require c·∫£ file <code class=\"language-text\">.json</code> v√† <code class=\"language-text\">.node</code> n·ªØa</li>\n<li>Ki·ªÉm tra xem file n√†y ƒë√£ ƒë∆∞·ª£c cache ch∆∞a, n·∫øu r·ªìi th√¨ tr·∫£ v·ªÅ k·∫øt qu·∫£ lu√¥n, n·∫øu ch∆∞a th√¨ ƒëi ti·∫øp b∆∞·ªõc 4</li>\n<li>Kh·ªüi t·∫°o m·ªôt private scope cho file, v√¨ v·∫≠y n√™n 2 bi·∫øn ‚Äúglobal‚Äù trong 2 file JS kh√°c nhau c√≥ th·ªÉ ƒë·∫∑t tr√πng t√™n ƒë∆∞·ª£c</li>\n<li>Load code v√†o b·ªô nh·ªõ</li>\n<li>Cache l·∫°i file n√†y</li>\n</ol>\n<p>ƒê·∫øn ƒë√¢y th√¨ d·ªÖ d√†ng ƒë·ªÉ nh·∫≠n ra v·∫•n ƒë·ªÅ r·ªìi. File <code class=\"language-text\">axon.js</code> ƒë∆∞·ª£c require 2 l·∫ßn khi ch·∫°y <code class=\"language-text\">jest --coverage</code>, nh∆∞ng khi debug ri√™ng 1 test case th√¨ n√≥ ch·ªâ ƒë∆∞·ª£c require 1 l·∫ßn. H√†m <code class=\"language-text\">axon.socket()</code> ch·ªâ th·ª±c thi m·ªôt l·∫ßn v√† ƒë∆∞·ª£c cache l·∫°i. Ch√≠nh v√¨ v·∫≠y n√™n test case fail m·ªõi fail :)) N·∫øu m√¨nh ƒë·ªïi th·ª© t·ª± cho test case succeed xu·ªëng d∆∞·ªõi th√¨ n√≥ m·ªõi l√† th·∫±ng b·ªã fail.</p>\n<p>N·∫øu v·∫≠y th√¨ l√†m sao gi·ªù? Th·ª≠ t√°ch test case ra 2 h√†m <code class=\"language-text\">describe()</code> xem sao? V·∫´n fail. Th·ª≠ t√°ch h·∫≥n ra 2 file, m·ªói file 1 test case. Pass! Nh∆∞ng m√† nh∆∞ n√†y t√π qu√°, kh√¥ng th·ªÉ c·ª© m·ªói test case ƒë·ªÉ 1 file ƒë∆∞·ª£c.</p>\n<h2 id=\"jestdomock-to-the-rescue\" style=\"position:relative;\"><a href=\"#jestdomock-to-the-rescue\" aria-label=\"jestdomock to the rescue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code class=\"language-text\">jest.doMock()</code> to the rescue!</h2>\n<p>H√†m n√†y s·∫Ω mock c·∫£ package <code class=\"language-text\">axon</code>, k·∫øt h·ª£p v·ªõi <code class=\"language-text\">jest.resetModules()</code> th√¨ m·ªói l·∫ßn g·∫∑p <code class=\"language-text\">require(&#39;axon&#39;)</code> trong code Jest s·∫Ω d√πng mock implementation c·ªßa m√¨nh ch·ª© kh√¥ng ph·∫£i ƒë·ªçc t·ª´ file, v√¨ v·∫≠y s·∫Ω kh√¥ng c√≤n cache trong require n·ªØa.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token function\">beforeEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    jest<span class=\"token punctuation\">.</span><span class=\"token function\">resetModules</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'doSomething() succeeds'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">done</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    jest<span class=\"token punctuation\">.</span><span class=\"token function\">doMock</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axon'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function-variable function\">socket</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function-variable function\">connect</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">addr<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> index <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connected <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> index<span class=\"token punctuation\">.</span><span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>connected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'doSomething() fails'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token parameter\">done</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    jest<span class=\"token punctuation\">.</span><span class=\"token function\">doMock</span><span class=\"token punctuation\">(</span><span class=\"token string\">'axon'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function-variable function\">socket</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n                    <span class=\"token function-variable function\">connect</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">addr<span class=\"token punctuation\">,</span> cb</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">cb</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">}</span>\n            <span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> index <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'./index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> connected <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> index<span class=\"token punctuation\">.</span><span class=\"token function\">doSomething</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>connected<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBe</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>K·∫øt qu·∫£ 2 test case ƒë·ªÅu pass ngon l√†nh, coverage 100% v√† m√¨nh c√≥ th·ªÉ y√™n t√¢m ƒëi v·ªÅ vi·∫øt b√†i blog n√†y. üéâ</p>\n<p>Hi v·ªçng b√†i vi·∫øt c√≥ √≠ch!</p>\n<p><em>Tham kh·∫£o t·ª´:</em></p>\n<ul>\n<li><em><a href=\"https://nodejs.org/dist/latest-v12.x/docs/api/modules.html#modules_require_id\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Modules | Node.js v12.16.1 Documentation</a></em></li>\n<li><em><a href=\"https://www.freecodecamp.org/news/requiring-modules-in-node-js-everything-you-need-to-know-e7fbd119be8/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Requiring modules in Node.js: Everything you need to know</a></em></li>\n<li><em><a href=\"https://stackoverflow.com/a/30038787/8943850\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">javascript - Requiring same module in multiple files - Stack Overflow</a></em></li>\n</ul>","fields":{"slug":"/posts/khi-require-mot-file-n-lan-thi-doan-code-ben-trong-file-do-chay-bao-nhieu-lan/","categorySlug":"/category/knowledge/","tagSlugs":["/tag/node-js/","/tag/jest/"]},"frontmatter":{"date":"2020-02-25T04:30:00.000Z","description":"H√¥m nay cu·ªëi sprint, ƒëang ho√†n th√†nh n·ªët c√°i coverage test cho ƒë√∫ng h·∫°n th√¨ m√¨nh g·∫∑p ph·∫£i t√¨nh hu·ªëng nh∆∞ th·∫ø n√†y.","tags":["node.js","jest"],"title":"Khi require m·ªôt file n l·∫ßn, th√¨ ƒëo·∫°n code b√™n trong file ƒë√≥ ch·∫°y bao nhi√™u l·∫ßn?","category":"Knowledge","socialImage":{"publicURL":"/static/a0400198d3676c79bc903482e2c0220e/thumb.png"}}}},"pageContext":{"slug":"/posts/khi-require-mot-file-n-lan-thi-doan-code-ben-trong-file-do-chay-bao-nhieu-lan/"}},"staticQueryHashes":["251939775","401334301","994130391"]}